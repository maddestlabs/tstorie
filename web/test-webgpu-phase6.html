<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TStorie WebGPU Phase 6 Test</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a1a;
            color: #e0e0e0;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #4CAF50;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #888;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .status {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 15px;
        }
        
        .status-item {
            background: #1a1a1a;
            padding: 12px;
            border-radius: 4px;
            border-left: 3px solid #4CAF50;
        }
        
        .status-item.error {
            border-left-color: #f44336;
        }
        
        .status-item.warning {
            border-left-color: #ff9800;
        }
        
        .status-label {
            font-size: 12px;
            color: #888;
            text-transform: uppercase;
            margin-bottom: 5px;
        }
        
        .status-value {
            font-size: 18px;
            font-weight: bold;
        }
        
        .canvas-container {
            background: #000;
            border: 2px solid #444;
            border-radius: 8px;
            padding: 20px;
            display: inline-block;
            margin-bottom: 20px;
        }
        
        canvas {
            display: block;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        
        .controls {
            background: #2a2a2a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        button {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.2s;
        }
        
        button:hover {
            background: #45a049;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        .log {
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 8px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 20px;
        }
        
        .log-entry {
            margin-bottom: 5px;
            padding: 5px;
            border-radius: 3px;
        }
        
        .log-entry.info {
            color: #4CAF50;
        }
        
        .log-entry.warning {
            color: #ff9800;
        }
        
        .log-entry.error {
            color: #f44336;
        }
        
        .badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: bold;
            text-transform: uppercase;
            margin-left: 10px;
        }
        
        .badge.webgpu {
            background: #4CAF50;
            color: white;
        }
        
        .badge.webgl {
            background: #2196F3;
            color: white;
        }
        
        .badge.error {
            background: #f44336;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>TStorie WebGPU Phase 6 Test</h1>
        <div class="subtitle">Full WebGPU Rendering Pipeline + Compute Shaders</div>
        
        <div class="status">
            <h3>Renderer Status</h3>
            <div class="status-grid">
                <div class="status-item" id="backend-status">
                    <div class="status-label">Backend</div>
                    <div class="status-value" id="backend-value">Initializing...</div>
                </div>
                <div class="status-item" id="webgpu-support">
                    <div class="status-label">WebGPU Support</div>
                    <div class="status-value" id="webgpu-support-value">Checking...</div>
                </div>
                <div class="status-item" id="webgl-support">
                    <div class="status-label">WebGL2 Support</div>
                    <div class="status-value" id="webgl-support-value">Checking...</div>
                </div>
                <div class="status-item" id="glyphs-cached">
                    <div class="status-label">Glyphs Cached</div>
                    <div class="status-value" id="glyphs-value">0</div>
                </div>
            </div>
        </div>
        
        <div class="controls">
            <h3>Test Controls</h3>
            <button id="test-render" onclick="testRender()">Test Render</button>
            <button id="test-colors" onclick="testColors()">Test Colors</button>
            <button id="test-unicode" onclick="testUnicode()">Test Unicode</button>
            <button id="test-styles" onclick="testStyles()">Test Styles</button>
            <button id="benchmark" onclick="runBenchmark()">Run Benchmark</button>
            <button id="export-png" onclick="exportPNG()">Export PNG</button>
        </div>
        
        <div class="canvas-container">
            <canvas id="terminal" width="800" height="480"></canvas>
        </div>
        
        <div class="log" id="log"></div>
    </div>
    
    <!-- Phase 6: Load all WebGPU components -->
    <script src="webgpu_bridge.js"></script>
    <script src="tstorie-webgl.js"></script>
    <script src="tstorie-webgpu-render.js"></script>
    <script src="tstorie-hybrid-renderer.js"></script>
    
    <script>
        let renderer = null;
        let webgpuBridge = null;
        
        function log(message, type = 'info') {
            const logDiv = document.getElementById('log');
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logDiv.appendChild(entry);
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        async function initRenderer() {
            const canvas = document.getElementById('terminal');
            
            log('Phase 6 initialization starting...', 'info');
            
            // Initialize WebGPU bridge first (for shared device)
            webgpuBridge = new WebGPUBridge();
            const bridgeReady = await webgpuBridge.init();
            
            if (bridgeReady) {
                log('âœ“ WebGPU bridge initialized', 'info');
            } else {
                log('âš  WebGPU bridge not available', 'warning');
            }
            
            // Create hybrid renderer (will use shared device if available)
            try {
                renderer = await createTStorieRenderer(canvas, {
                    preferWebGPU: true,
                    webgpuBridge: webgpuBridge,
                    fallbackToWebGL: true,
                    fontSize: 16
                });
                
                const backend = renderer.getBackend();
                const stats = renderer.getStats();
                
                // Update status
                document.getElementById('backend-value').textContent = backend.toUpperCase();
                document.getElementById('backend-status').className = 
                    `status-item ${backend === 'webgpu' ? '' : 'warning'}`;
                
                document.getElementById('webgpu-support-value').textContent = 
                    stats.webgpuAvailable ? 'Yes âœ“' : 'No âœ—';
                document.getElementById('webgpu-support').className = 
                    `status-item ${stats.webgpuAvailable ? '' : 'error'}`;
                
                document.getElementById('webgl-support-value').textContent = 
                    stats.webglAvailable ? 'Yes âœ“' : 'No âœ—';
                
                log(`âœ“ Renderer initialized using ${backend.toUpperCase()}`, 'info');
                
                if (backend === 'webgpu') {
                    log('ðŸš€ Phase 6: Full WebGPU rendering active!', 'info');
                    log('   - Unified GPU context (compute + render)', 'info');
                    log('   - WGSL shaders for terminal rendering', 'info');
                    log('   - WebGPU compute for noise generation', 'info');
                } else if (backend === 'webgl') {
                    log('âš  Using WebGL fallback', 'warning');
                    log('   - WebGPU not available in this browser', 'warning');
                }
                
                // Run initial test
                testRender();
                
            } catch (error) {
                log(`âœ— Renderer initialization failed: ${error.message}`, 'error');
                document.getElementById('backend-value').textContent = 'FAILED';
                document.getElementById('backend-status').className = 'status-item error';
            }
        }
        
        function testRender() {
            if (!renderer) return;
            
            log('Running basic render test...', 'info');
            
            const { cols, rows } = renderer.getDimensions();
            const cells = [];
            
            // Create test pattern
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const char = ((x + y) % 2 === 0) ? 'â–ˆ' : 'â–‘';
                    const fg = `#${Math.floor(Math.random() * 16777215).toString(16).padStart(6, '0')}`;
                    
                    cells.push({
                        char: char,
                        fg: fg,
                        bg: '#000000'
                    });
                }
            }
            
            renderer.render(cells);
            updateStats();
            log('âœ“ Render test complete', 'info');
        }
        
        function testColors() {
            if (!renderer) return;
            
            log('Testing color rendering...', 'info');
            
            const { cols, rows } = renderer.getDimensions();
            const cells = [];
            
            const colors = ['#ff0000', '#00ff00', '#0000ff', '#ffff00', '#ff00ff', '#00ffff'];
            
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const colorIdx = Math.floor((x / cols) * colors.length);
                    cells.push({
                        char: 'â–ˆ',
                        fg: colors[colorIdx],
                        bg: '#000000'
                    });
                }
            }
            
            renderer.render(cells);
            updateStats();
            log('âœ“ Color test complete', 'info');
        }
        
        function testUnicode() {
            if (!renderer) return;
            
            log('Testing Unicode rendering...', 'info');
            
            const { cols, rows } = renderer.getDimensions();
            const cells = [];
            
            const unicodeChars = ['â–‘', 'â–’', 'â–“', 'â–ˆ', 'â–€', 'â–„', 'â–Œ', 'â–', 'â—', 'â—‹', 'â—†', 'â—‡'];
            
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const char = unicodeChars[(x + y) % unicodeChars.length];
                    cells.push({
                        char: char,
                        fg: '#00ff00',
                        bg: '#000000'
                    });
                }
            }
            
            renderer.render(cells);
            updateStats();
            log('âœ“ Unicode test complete', 'info');
        }
        
        function testStyles() {
            if (!renderer) return;
            
            log('Testing text styles...', 'info');
            
            const { cols, rows } = renderer.getDimensions();
            const cells = [];
            
            for (let y = 0; y < rows; y++) {
                for (let x = 0; x < cols; x++) {
                    const bold = y % 4 === 0;
                    const underline = y % 4 === 2;
                    
                    cells.push({
                        char: 'A',
                        fg: '#ffffff',
                        bg: '#000000',
                        bold: bold,
                        underline: underline
                    });
                }
            }
            
            renderer.render(cells);
            updateStats();
            log('âœ“ Style test complete', 'info');
        }
        
        async function runBenchmark() {
            if (!renderer) return;
            
            log('Running benchmark...', 'info');
            
            const iterations = 100;
            const start = performance.now();
            
            for (let i = 0; i < iterations; i++) {
                testRender();
            }
            
            const end = performance.now();
            const avgTime = (end - start) / iterations;
            const fps = 1000 / avgTime;
            
            log(`âœ“ Benchmark complete: ${avgTime.toFixed(2)}ms per frame (${fps.toFixed(1)} FPS)`, 'info');
        }
        
        async function exportPNG() {
            if (!renderer) return;
            
            log('Exporting PNG...', 'info');
            
            try {
                const blob = await renderer.exportPNG();
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `tstorie-phase6-${Date.now()}.png`;
                a.click();
                URL.revokeObjectURL(url);
                
                log('âœ“ PNG exported successfully', 'info');
            } catch (error) {
                log(`âœ— PNG export failed: ${error.message}`, 'error');
            }
        }
        
        function updateStats() {
            if (!renderer) return;
            
            const stats = renderer.getStats();
            document.getElementById('glyphs-value').textContent = stats.glyphsCached || 0;
        }
        
        // Initialize on page load
        window.addEventListener('load', () => {
            log('=== TStorie WebGPU Phase 6 Test ===', 'info');
            log('Checking browser capabilities...', 'info');
            initRenderer();
        });
    </script>
</body>
</html>
