<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TStorie Module Loading Test</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            background: #1a1a1a;
            color: #0f0;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        h1 {
            color: #0ff;
            margin-bottom: 20px;
        }
        
        .section {
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        
        .section h2 {
            color: #0ff;
            margin-bottom: 15px;
            font-size: 18px;
        }
        
        button {
            background: #0f0;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: inherit;
            font-size: 14px;
            font-weight: bold;
            border-radius: 4px;
        }
        
        button:hover {
            background: #0ff;
        }
        
        button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        
        #canvas {
            border: 2px solid #0ff;
            display: block;
            margin: 20px 0;
            image-rendering: pixelated;
        }
        
        .log {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .log-entry {
            padding: 2px 0;
            font-family: 'Courier New', monospace;
        }
        
        .log-info { color: #0f0; }
        .log-warn { color: #ff0; }
        .log-error { color: #f00; }
        
        .status {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 3px;
            font-size: 11px;
            font-weight: bold;
            margin-left: 10px;
        }
        
        .status-loading { background: #ff0; color: #000; }
        .status-loaded { background: #0f0; color: #000; }
        .status-error { background: #f00; color: #fff; }
        
        .plugin-item {
            padding: 8px;
            background: #111;
            margin: 5px 0;
            border-left: 3px solid #333;
        }
        
        .plugin-item.loaded {
            border-left-color: #0f0;
        }
        
        .metric {
            display: inline-block;
            padding: 8px 12px;
            background: #111;
            margin: 5px;
            border: 1px solid #333;
        }
        
        .metric-label {
            color: #888;
            font-size: 11px;
        }
        
        .metric-value {
            color: #0ff;
            font-size: 18px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ðŸš€ TStorie Module Loading Test</h1>
        
        <div class="section">
            <h2>Canvas</h2>
            <canvas id="canvas" width="800" height="600"></canvas>
        </div>
        
        <div class="section">
            <h2>Core Module</h2>
            <button id="btn-load-core" onclick="loadCore()">Load Core Module</button>
            <button id="btn-start-main" onclick="startMain()" disabled>Start Main Loop</button>
            <span id="core-status"></span>
            <div class="log" id="core-log"></div>
        </div>
        
        <div class="section">
            <h2>Plugins</h2>
            <button onclick="loadPluginManual('ttf')">Load TTF Plugin</button>
            <button onclick="loadPluginManual('audio')" disabled>Load Audio Plugin (planned)</button>
            <button onclick="loadPluginManual('particles')" disabled>Load Particles Plugin (planned)</button>
            <div id="plugin-list"></div>
        </div>
        
        <div class="section">
            <h2>Status & Metrics</h2>
            <button onclick="showStatus()">Show Status</button>
            <button onclick="showNimStatus()">Show Nim Status</button>
            <button onclick="clearLogs()">Clear Logs</button>
            <div id="metrics">
                <div class="metric">
                    <div class="metric-label">Load Time</div>
                    <div class="metric-value" id="metric-time">--</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Plugins Loaded</div>
                    <div class="metric-value" id="metric-plugins">0</div>
                </div>
                <div class="metric">
                    <div class="metric-label">Core Size</div>
                    <div class="metric-value">1.9MB</div>
                </div>
            </div>
            <div class="log" id="status-log"></div>
        </div>
    </div>
    
    <script src="progressive-loader.js"></script>
    <script>
        let loader = null;
        const startTime = performance.now();
        
        // Logging helper
        function log(message, type = 'info', target = 'core-log') {
            const logEl = document.getElementById(target);
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(entry);
            logEl.scrollTop = logEl.scrollHeight;
            
            // Also log to console
            const logFn = type === 'error' ? console.error : type === 'warn' ? console.warn : console.log;
            logFn(`[Test] ${message}`);
        }
        
        // Update status indicator
        function updateStatus(elementId, status, text) {
            const el = document.getElementById(elementId);
            el.innerHTML = `<span class="status status-${status}">${text}</span>`;
        }
        
        // Update plugin list
        function updatePluginList() {
            if (!loader) return;
            
            const listEl = document.getElementById('plugin-list');
            listEl.innerHTML = '';
            
            for (const [name, config] of Object.entries(loader.pluginConfig)) {
                const isLoaded = loader.loadedPlugins.has(name);
                const item = document.createElement('div');
                item.className = `plugin-item ${isLoaded ? 'loaded' : ''}`;
                item.innerHTML = `
                    <strong>${name}</strong> - ${config.description}
                    <span class="status status-${isLoaded ? 'loaded' : 'loading'}">
                        ${isLoaded ? 'LOADED' : config.status === 'planned' ? 'PLANNED' : 'NOT LOADED'}
                    </span>
                    <br>
                    <small>Size: ${config.size}KB | Path: ${config.path}</small>
                `;
                listEl.appendChild(item);
            }
        }
        
        // Load core module
        async function loadCore() {
            log('Initializing loader...');
            updateStatus('core-status', 'loading', 'LOADING');
            
            try {
                loader = new ProgressiveLoader();
                window.loader = loader; // For console access
                
                await loader.init('canvas');
                
                const loadTime = (performance.now() - startTime).toFixed(0);
                document.getElementById('metric-time').textContent = `${loadTime}ms`;
                
                log(`Core loaded successfully in ${loadTime}ms`, 'info');
                updateStatus('core-status', 'loaded', 'LOADED');
                
                document.getElementById('btn-load-core').disabled = true;
                document.getElementById('btn-start-main').disabled = false;
                
                updatePluginList();
            } catch (error) {
                log(`Failed to load core: ${error.message}`, 'error');
                updateStatus('core-status', 'error', 'ERROR');
            }
        }
        
        // Start main loop
        function startMain() {
            if (!loader || !loader.coreModule) {
                log('Core module not loaded', 'error');
                return;
            }
            
            log('Starting main loop...');
            
            try {
                loader.startMainLoop();
                log('Main loop started', 'info');
                document.getElementById('btn-start-main').disabled = true;
            } catch (error) {
                log(`Failed to start main loop: ${error.message}`, 'error');
            }
        }
        
        // Load plugin manually
        async function loadPluginManual(pluginName) {
            if (!loader) {
                log('Core module not loaded yet', 'error');
                return;
            }
            
            log(`Loading plugin: ${pluginName}`, 'info');
            
            try {
                const success = await loader.loadPlugin(pluginName);
                
                if (success) {
                    log(`Plugin ${pluginName} loaded successfully`, 'info');
                    document.getElementById('metric-plugins').textContent = loader.loadedPlugins.size;
                } else {
                    log(`Plugin ${pluginName} failed to load`, 'error');
                }
                
                updatePluginList();
            } catch (error) {
                log(`Error loading plugin ${pluginName}: ${error.message}`, 'error');
            }
        }
        
        // Show loader status
        function showStatus() {
            if (!loader) {
                log('Loader not initialized', 'warn', 'status-log');
                return;
            }
            
            const status = loader.getStatus();
            log('=== Loader Status ===', 'info', 'status-log');
            log(`Core Loaded: ${status.coreLoaded}`, 'info', 'status-log');
            log(`Plugins Loaded: ${status.loadedPlugins.join(', ') || 'none'}`, 'info', 'status-log');
            log(`Available Plugins: ${status.availablePlugins.join(', ')}`, 'info', 'status-log');
            log(`Uptime: ${status.uptime.toFixed(0)}ms`, 'info', 'status-log');
            
            if (status.nimPlugins) {
                log(`Nim Plugin Status: ${JSON.stringify(status.nimPlugins)}`, 'info', 'status-log');
            }
        }
        
        // Show Nim-side status
        function showNimStatus() {
            if (!loader || !loader.coreModule) {
                log('Core module not loaded', 'warn', 'status-log');
                return;
            }
            
            try {
                if (typeof loader.coreModule._getPluginStatus === 'function') {
                    const statusPtr = loader.coreModule._getPluginStatus();
                    const statusStr = loader.coreModule.UTF8ToString(statusPtr);
                    const status = JSON.parse(statusStr);
                    
                    log('=== Nim Plugin Status ===', 'info', 'status-log');
                    log(`TTF Plugin: ${status.ttf ? 'loaded' : 'not loaded'}`, 'info', 'status-log');
                    log(`Debug Font: ${status.debugFont ? 'active' : 'inactive'}`, 'info', 'status-log');
                } else {
                    log('getPluginStatus not available', 'warn', 'status-log');
                }
            } catch (error) {
                log(`Error getting Nim status: ${error.message}`, 'error', 'status-log');
            }
        }
        
        // Clear logs
        function clearLogs() {
            document.getElementById('core-log').innerHTML = '';
            document.getElementById('status-log').innerHTML = '';
        }
        
        // Auto-load core on page load (optional)
        window.addEventListener('load', () => {
            log('Test page loaded. Click "Load Core Module" to begin.', 'info');
        });
        
        // Console helpers
        window.testLoadPlugin = loadPluginManual;
        window.testShowStatus = showStatus;
        
        console.log('=== TStorie Module Loading Test ===');
        console.log('Available commands:');
        console.log('  loadCore() - Load the core module');
        console.log('  startMain() - Start the main loop');
        console.log('  loadPluginManual("ttf") - Load a plugin');
        console.log('  showStatus() - Show loader status');
        console.log('  showNimStatus() - Show Nim-side status');
        console.log('  loader.getStatus() - Get status object');
    </script>
</body>
</html>
