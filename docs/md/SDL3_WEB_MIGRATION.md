# SDL3 Web Migration - Cleanup Plan

## Overview
This document outlines the old WASM/web code that can now be removed after migrating to the SDL3 backend.

## New SDL3 Web Infrastructure (✓ Complete)

### Created Files:
- `backends/sdl3/web_interop.nim` - Minimal web-specific interop (URL params, gist loading)
- `build-web-sdl3.sh` - SDL3 web build script using Emscripten's built-in SDL3 support
- `docs/index-sdl3.html` - (auto-generated) Minimal HTML wrapper for SDL3 canvas

### Integration Points:
- `tstorie.nim` lines 25-28 - Import web_interop for SDL3 backend
- `tstorie.nim` lines 163-176 - Use web_interop for gist loading
- `tstorie.nim` lines 1458-1487 - SDL3 web initialization with URL param parsing

## Old Code to Remove

### 1. JavaScript Bridge Files (web/*.js)
**Location:** `web/` directory  
**Size:** ~50KB of JS glue code  
**Files:**
- `web/console_bridge.js` - Console logging bridge (replaced by web_interop EM_ASM)
- `web/audio_bridge.js` - Audio system bridge (SDL3 has built-in audio)
- `web/figlet_bridge.js` - FIGlet font loading (not needed in SDL3)
- `web/document_bridge.js` - DOM manipulation (minimal in SDL3)
- `web/font_metrics_bridge.js` - Font measurement (SDL3_ttf handles this)
- `web/file_drop_bridge.js` - File drop handling (SDL3 events handle this)

**Recommendation:** Keep `web/` directory for reference during migration, delete later.

### 2. Old WASM Glue in tstorie.nim (lines 590-1300)
**Location:** `tstorie.nim` lines 590-1300  
**What it does:** Massive `when defined(emscripten)` block with:
- Custom WASM exports (`emInit`, `emUpdate`, `emGetCell`, etc.)
- JS bridge function imports (`emLoadFont`, `emLoadShaders`, `emSetFontSize`)
- WASM-specific state management (`globalState`, `wasmPendingParams`)
- Manual render loop management (`renderStorie`, `emUpdate`)

**Can be removed AFTER:**
1. Verifying SDL3 web build works
2. Confirming all functionality is replaced
3. Updating examples/demos to use SDL3 version

**Replacement:** SDL3 handles all this automatically through Emscripten's SDL3 port.

### 3. Old Build Script (build-web.sh)
**Location:** `build-web.sh`  
**Size:** ~238 lines  
**Replaced by:** `build-web-sdl3.sh` (much simpler - ~180 lines)

**Key differences:**
```bash
# Old: Complex EXPORTED_FUNCTIONS list (20+ functions)
--passL:EXPORTED_FUNCTIONS=['_malloc','_free','_emInit','_emUpdate',...20 more]

# New: Minimal exports (SDL3 handles the rest)
--passL:EXPORTED_FUNCTIONS=['_main','_malloc','_free']
```

**Recommendation:** Rename to `build-web-legacy.sh` for reference, use `build-web-sdl3.sh` as primary.

### 4. Old HTML/JS Files
**Location:** `docs/` directory  
**Files:**
- `docs/tstorie.wasm.js` - Generated WASM glue (large, ~2MB)
- `docs/tstorie-webgl.js` - WebGL renderer with complex glue
- `docs/index.html` - Uses old WASM API

**Replaced by:**
- `docs/tstorie-sdl3.js` - Generated by Emscripten with SDL3
- `docs/tstorie-sdl3.wasm` - Simpler WASM module
- `docs/index-sdl3.html` - Minimal SDL3 canvas wrapper

**Recommendation:** Keep old files as `*-legacy.*` during migration.

### 5. nimini_bridge.nim WASM-specific code
**Location:** `lib/nimini_bridge.nim` line 13  
**Code:**
```nim
proc emConsoleLog(msg: cstring) {.importc: "emConsoleLog".}
```

**Replacement:** `web_interop.consoleLog()` for SDL3 web builds.

**Recommendation:** Add `when defined(emscripten) and not defined(sdl3Backend)` guards.

## Migration Strategy

### Phase 1: Parallel Deployment (CURRENT)
- ✓ SDL3 web build infrastructure complete
- ✓ SDL3 backend compiles successfully
- Keep both old and new systems running
- Test SDL3 web build: `./build-web-sdl3.sh -s`
- Gradually migrate users to `index-sdl3.html`

### Phase 2: Feature Parity
- Implement full SDL3 main loop (event handling, rendering)
- Port URL parameter handling (✓ done in web_interop)
- Port gist loading (✓ done in web_interop)
- Test all demos work with SDL3 web build

### Phase 3: Deprecation
- Mark old build as deprecated
- Rename files:
  - `build-web.sh` → `build-web-legacy.sh`
  - `index.html` → `index-legacy.html`
- Update documentation to recommend SDL3 build

### Phase 4: Removal
- Remove old WASM glue code from `tstorie.nim`
- Remove JS bridge files from `web/`
- Remove legacy build artifacts
- Update all references to use SDL3 build

## Code Removal Checklist

### Can Remove Immediately:
- [ ] None yet - need to verify SDL3 web build works first

### Can Remove After Testing:
- [ ] `tstorie.nim` lines 590-700 (WASM-specific functions and imports)
- [ ] `tstorie.nim` lines 701-1300 (WASM exports and render loop)
- [ ] `web/console_bridge.js` (replaced by web_interop)
- [ ] `web/font_metrics_bridge.js` (SDL3_ttf handles fonts)
- [ ] `web/file_drop_bridge.js` (SDL3 events handle drops)

### Keep for Reference:
- `build-web.sh` → rename to `build-web-legacy.sh`
- `docs/index.html` → rename to `docs/index-legacy.html`
- `web/` directory → move to `web-legacy/`

### Dependencies:
- Remove `web/*.js` bridge references from `build-web.sh`:
  ```bash
  --passL:--js-library --passL:web/console_bridge.js \
  --passL:--js-library --passL:web/audio_bridge.js \
  # ... etc
  ```

## Benefits of SDL3 Web Build

1. **Simpler Code:** ~700 lines of WASM glue removed
2. **Smaller Binary:** No custom JS bridges needed
3. **Better Performance:** Native SDL3 event loop instead of custom glue
4. **Unified Codebase:** Same backend for desktop and web
5. **Easier Maintenance:** SDL3 team maintains Emscripten port
6. **Modern APIs:** SDL3's event system works identically on web

## Testing the New Build

```bash
# Build SDL3 web version
./build-web-sdl3.sh -s

# Open in browser
# http://localhost:8000/index-sdl3.html

# Test URL parameters
# http://localhost:8000/index-sdl3.html?gist=abc123&theme=dark
```

## Next Steps

1. Complete SDL3 main loop implementation (event handling, rendering)
2. Test with existing tStorie demos
3. Verify all web features work (URL params, gist loading, etc.)
4. Performance comparison: SDL3 vs old WebGL approach
5. Document any differences for users
6. Create migration guide for existing tStorie web content
7. Remove old code after 30-day verification period

---

**Status:** ✓ Phase 1 Complete - SDL3 web infrastructure ready  
**Next:** Implement full SDL3 main loop and test with demos
