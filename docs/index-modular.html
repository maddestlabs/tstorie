<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TStorie SDL3 - Default Build with TTF</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: #1a1a1a;
      color: #fff;
      font-family: 'Courier New', monospace;
    }
    
    #container {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    
    #status-bar {
      background: #2a2a2a;
      padding: 10px;
      border-bottom: 1px solid #444;
    }
    
    #canvas-container {
      flex: 1;
      display: flex;
      justify-content: center;
      align-items: center;
      position: relative;
    }
    
    #canvas {
      background: #000;
      /* Use smooth rendering for anti-aliased TTF fonts */
      image-rendering: auto;
      image-rendering: -webkit-optimize-contrast;
      outline: none;
    }
    
    #loading-indicator {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      padding: 20px 40px;
      border-radius: 8px;
      border: 2px solid #0f0;
      display: none;
      z-index: 1000;
    }
    
    .loading-spinner {
      display: inline-block;
      width: 16px;
      height: 16px;
      border: 2px solid #0f0;
      border-top-color: transparent;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
      vertical-align: middle;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    #plugin-status {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }
    
    .plugin-badge {
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      border: 1px solid #444;
    }
    
    .plugin-badge.loaded {
      background: #0a4;
      border-color: #0f0;
    }
    
    .plugin-badge.loading {
      background: #440;
      border-color: #f80;
      animation: pulse 1s infinite;
    }
    
    .plugin-badge.not-loaded {
      background: #222;
      border-color: #444;
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    
    #info {
      margin-top: 10px;
      font-size: 12px;
      color: #888;
    }
    
    #demo-nav {
      margin-top: 10px;
      font-size: 11px;
    }
    
    #demo-nav a {
      color: #4a9eff;
      text-decoration: none;
      margin-right: 10px;
    }
    
    #demo-nav a:hover {
      text-decoration: underline;
    }
    
    #error-message {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: #a00;
      padding: 10px 20px;
      border-radius: 4px;
      display: none;
    }
  </style>
</head>
<body>
  <div id="container">
    <div id="status-bar">
      <div><strong>TStorie SDL3</strong> - Default Build (includes TTF)</div>
      <div id="plugin-status">
        <div class="plugin-badge loaded" data-plugin="core">Core âœ“</div>
        <div class="plugin-badge loaded" data-plugin="ttf">TTF Fonts âœ“</div>
        <div class="plugin-badge not-loaded" data-plugin="effects">Effects (future)</div>
        <div class="plugin-badge not-loaded" data-plugin="audio">Audio ðŸ”Š (future)</div>
      </div>
      <div id="info">
        <span id="load-time"></span>
        <span id="plugin-info"></span>
      </div>
      <div id="demo-nav">
        Quick demos: 
        <a href="?content=minimal">minimal</a>
        <a href="?content=styles">styles</a>
        <a href="?content=asciiart">asciiart</a>
        <a href="?content=ansiart">ansiart</a>
        <a href="?content=figlets">figlets</a>
        <a href="?content=particles">particles</a>
        <a href="?content=dungen">dungeon</a>
      </div>
    </div>
    
    <div id="canvas-container">
      <canvas id="canvas" width="800" height="600" tabindex="0"></canvas>
      
      <div id="loading-indicator">
        <div class="loading-spinner"></div>
        <span id="loading-text">Loading...</span>
      </div>
    </div>
  </div>
  
  <div id="error-message"></div>
  
  <!-- Progressive font loader: starts with 250KB minimal font, loads 2.6MB Nerd Font in background -->
  <script src="progressive_font_loader.js"></script>
  
  <script src="tstorie.js"></script>
  <script>
    // Track timing
    const appStartTime = performance.now();
    
    // Update UI helpers
    function updateLoadTime(time) {
      document.getElementById('load-time').textContent = 
        `Loaded in ${time.toFixed(0)}ms | `;
    }
    
    function updatePluginInfo(text) {
      document.getElementById('plugin-info').textContent = text;
    }
    
    function showLoading(text) {
      const indicator = document.getElementById('loading-indicator');
      const loadingText = document.getElementById('loading-text');
      loadingText.textContent = text;
      indicator.style.display = 'block';
    }
    
    function hideLoading() {
      document.getElementById('loading-indicator').style.display = 'none';
    }
    
    // Main initialization
    async function init() {
      console.log('[App] Starting TStorie with TTF support...');
      
      showLoading('Loading WASM module...');
      
      // Get canvas reference before module loads
      const canvas = document.getElementById('canvas');
      
      // Load the module with canvas pre-configured
      const moduleStartTime = performance.now();
      const Module = await TStorie({
        canvas: canvas,
        print: (text) => console.log('[WASM]', text),
        printErr: (text) => console.error('[WASM]', text),
        // Ensure canvas is set before SDL_Init
        preRun: [],
        postRun: [() => {
          console.log('[Init] Module postRun - focusing canvas');
          canvas.focus();
        }],
      });
      
      const loadTime = performance.now() - moduleStartTime;
      updateLoadTime(loadTime);
      updatePluginInfo('TTF rendering ready (Unicode, anti-aliasing)');
      
      hideLoading();
      
      // Focus canvas to receive keyboard/mouse events
      canvas.focus();
      
      // SDL3 handles events automatically via Emscripten - let it work
      console.log('[Init] SDL3 should handle events automatically');
      console.log('[Init] Module.canvas:', Module.canvas);
      console.log('[Init] Canvas element:', canvas);
      
      console.log('[App] Module loaded successfully');
      console.log('[App] Total initialization time:', (performance.now() - appStartTime).toFixed(0), 'ms');
      
      // Make Module globally accessible for progressive font loader
      window.Module = Module;
      
      // Start progressive font loading (3270-Regular â†’ 3270 Nerd Font after 2s)
      if (window.progressiveFontLoader) {
        window.progressiveFontLoader.init();
      }
      
      // Handle dynamic content loading from URL parameter
      const urlParams = new URLSearchParams(window.location.search);
      const contentParam = urlParams.get('content');
      
      if (contentParam) {
        console.log('[App] Loading content:', contentParam);
        showLoading(`Loading ${contentParam}...`);
        
        // Determine content path
        let contentUrl;
        if (contentParam.startsWith('http://') || contentParam.startsWith('https://')) {
          // External URL
          contentUrl = contentParam;
        } else if (contentParam.startsWith('/')) {
          // Absolute path
          contentUrl = contentParam;
        } else {
          // Relative path - assume it's a demo
          const demoFile = contentParam.endsWith('.md') ? contentParam : contentParam + '.md';
          contentUrl = 'demos/' + demoFile;
        }
        
        try {
          const response = await fetch(contentUrl);
          if (!response.ok) {
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
          }
          
          const markdown = await response.text();
          console.log('[App] Fetched', markdown.length, 'bytes from', contentUrl);
          console.log('[App] First 200 chars:', markdown.substring(0, 200));
          
          // Give module a moment to fully initialize the canvas
          await new Promise(resolve => setTimeout(resolve, 100));
          
          // Inject content using exported function
          console.log('[App] Calling setMarkdownContent...');
          try {
            Module.ccall('setMarkdownContent', null, ['string'], [markdown]);
            console.log('[App] Content loaded successfully');
          } catch (e) {
            console.error('[App] Error calling setMarkdownContent:', e);
            throw e;
          }
          
          hideLoading();
        } catch (error) {
          console.error('[App] Failed to load content:', error);
          hideLoading();
          document.getElementById('error-message').textContent = 
            `Failed to load ${contentParam}: ${error.message}`;
          document.getElementById('error-message').style.display = 'block';
        }
      }
    }
    
    // Start the app
    init().catch(error => {
      console.error('[App] Initialization failed:', error);
      document.getElementById('error-message').textContent = 
        `Failed to initialize: ${error.message}`;
      document.getElementById('error-message').style.display = 'block';
      hideLoading();
    });
  </script>
</body>
</html>
