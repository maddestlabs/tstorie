# Generated by tStorie Nim Export (Standalone)
# Source: untitled.md

import times, os
import std/[strutils, tables]  # For join and getOrDefault
import src/types
import src/layers
import src/appstate
when not defined(emscripten):
  import src/platform/terminal

# Global state
var gState: AppState
var gBgLayer, gFgLayer: Layer  # Layer references for drawing API
var gRunning {.global.} = true
when not defined(emscripten):
  var gTerminalState: TerminalState

# Unified Drawing API - works with any layer
proc draw(layer: string, x, y: int, text: string, style: Style = defaultStyle()) =
  let targetLayer = if layer == "foreground": gFgLayer elif layer == "background": gBgLayer else: return
  targetLayer.buffer.writeText(x, y, text, style)

proc clear(layer: string, transparent: bool = false) =
  let targetLayer = if layer == "foreground": gFgLayer elif layer == "background": gBgLayer else: return
  if transparent: targetLayer.buffer.clearTransparent() else: targetLayer.buffer.clear()

proc fillRect(layer: string, x, y, w, h: int, ch: string, style: Style = defaultStyle()) =
  let targetLayer = if layer == "foreground": gFgLayer elif layer == "background": gBgLayer else: return
  targetLayer.buffer.fillRect(x, y, w, h, ch, style)

# Runtime helper functions
proc print(args: varargs[string, `$`]) = echo args.join(" ")
template termWidth: int = gState.termWidth
template termHeight: int = gState.termHeight
proc getStyle(name: string): Style =
  if gState.styleSheet.hasKey(name):
    let sc = gState.styleSheet[name]
    result = Style(
      fg: Color(r: sc.fg.r, g: sc.fg.g, b: sc.fg.b),
      bg: Color(r: sc.bg.r, g: sc.bg.g, b: sc.bg.b),
      bold: sc.bold, italic: sc.italic, underline: sc.underline, dim: sc.dim)
  else:
    result = defaultStyle()

# User global variables
var lower
var repeated
var charFromCode
var endsD
var message: string
var charCode
var testStr: string
var trimmed
var upper
var joined
var findPos
var replaced
var startsH
var words

proc main() =
  when not defined(emscripten):
    gTerminalState = setupRawMode()
    hideCursor()
    
    let (w, h) = getTermSize()
    gState = newAppState(w, h)
    
    # Initialize standard layers
    gBgLayer = newLayer("background", w, h, 0)
    gFgLayer = newLayer("foreground", w, h, 1)
    gState.layers.add(gBgLayer)
    gState.layers.add(gFgLayer)
    
    # Initialization
    testStr = "Hello World"
    message = ""
    
    # Test chr and ord
    charCode = ord("A")
    charFromCode = chr(65)
    
    # Test case conversion
    upper = toUpper(testStr)
    lower = toLower(testStr)
    
    # Test string checks
    startsH = startsWith(testStr, "Hello")
    endsD = endsWith(testStr, "World")
    
    # Test split and join
    words = split(testStr, " ")
    joined = join(words, "-")
    
    # Test strip
    var spacey = "  trimmed  "
    trimmed = strip(spacey)
    
    # Test replace
    replaced = replace(testStr, "World", "Nimini")
    
    # Test find
    findPos = findStr(testStr, "World")
    
    # Test repeat
    repeated = repeat("*", 5)
    
    message = "String ops loaded!"

    var lastTime = epochTime()
    
    try:
      # Main loop
      while gState.running and gRunning:
        let currentTime = epochTime()
        let deltaTime = currentTime - lastTime
        lastTime = currentTime
        
        # Update FPS counter
        gState.updateFpsCounter(deltaTime)
        
        # Render
        clear()
        
        var y = 2
        draw(0, 2, y, "=== STRING OPERATIONS DEMO ===")
        y = y + 2
        
        draw(0, 2, y, "Original: " & testStr)
        y = y + 1
        
        draw(0, 2, y, "chr(65) = " & charFromCode)
        y = y + 1
        
        draw(0, 2, y, "ord('A') = " & str(charCode))
        y = y + 1
        
        draw(0, 2, y, "toUpper: " & upper)
        y = y + 1
        
        draw(0, 2, y, "toLower: " & lower)
        y = y + 1
        
        draw(0, 2, y, "startsWith 'Hello': " & str(startsH))
        y = y + 1
        
        draw(0, 2, y, "endsWith 'World': " & str(endsD))
        y = y + 1
        
        draw(0, 2, y, "split by space: [" & words[0] & ", " & words[1] & "]")
        y = y + 1
        
        draw(0, 2, y, "join with '-': " & joined)
        y = y + 1
        
        draw(0, 2, y, "strip '  trimmed  ': '" & trimmed & "'")
        y = y + 1
        
        draw(0, 2, y, "replace World->Nimini: " & replaced)
        y = y + 1
        
        draw(0, 2, y, "find 'World' at: " & str(findPos))
        y = y + 1
        
        draw(0, 2, y, "repeat '*' x5: " & repeated)
        y = y + 1
        
        y = y + 1
        draw(0, 2, y, message)

        # Composite layers and display to terminal
        gState.compositeLayers()
        gState.currentBuffer.display(gState.previousBuffer, gState.colorSupport)

        # Frame rate limiting
        if gState.targetFps > 0.0:
          let frameTime = epochTime() - currentTime
          let targetFrameTime = 1.0 / gState.targetFps
          let sleepTime = targetFrameTime - frameTime
          if sleepTime > 0:
            sleep(int(sleepTime * 1000))
    finally:
      # Cleanup terminal
      showCursor()
      clearScreen()
      restoreTerminal(gTerminalState)
      stdout.write("\n")
      stdout.flushFile()

when isMainModule:
  main()
